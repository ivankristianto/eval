---
import Icon from './Icon.astro';

/**
 * Drawer component for side panel overlays
 *
 * @example
 * <Drawer id="details-drawer" title="Details" width="lg">
 *   <p>Content goes here</p>
 *   <div slot="footer">
 *     <Button>Close</Button>
 *   </div>
 * </Drawer>
 *
 * @param id - Unique identifier for the drawer (required)
 * @param title - Optional drawer title displayed in header
 * @param width - Drawer width size (default: 'md')
 *
 * @slot default - Main drawer content
 * @slot title - Custom title content (overrides title prop)
 * @slot footer - Optional footer content with border separator
 */
export interface Props {
  id: string;
  title?: string;
  width?: 'sm' | 'md' | 'lg' | 'xl';
}

const { id, title, width = 'md' } = Astro.props;

const widthClasses = {
  sm: 'max-w-sm',
  md: 'max-w-md',
  lg: 'max-w-lg',
  xl: 'max-w-xl',
};
---

<!-- Drawer backdrop -->
<div
  id={`${id}-backdrop`}
  class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden opacity-0 transition-opacity duration-300"
  data-drawer-backdrop={id}
>
</div>

<!-- Drawer panel -->
<div
  id={id}
  class={`fixed top-0 right-0 h-full w-full ${widthClasses[width]} bg-base-100 z-[70] transform translate-x-full transition-transform duration-300 ease-in-out overflow-hidden flex flex-col`}
  data-drawer
>
  <!-- Header -->
  <div class="flex items-center justify-between p-6 border-b border-gold-light">
    {
      title && (
        <h2 class="font-display text-2xl font-semibold text-gradient-gold" id={`${id}-title`}>
          {title}
        </h2>
      )
    }
    <slot name="title" />
    <button
      type="button"
      class="btn btn-ghost btn-sm btn-circle"
      data-drawer-close={id}
      aria-label="Close"
    >
      <Icon name="close" size="md" />
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    <slot />
  </div>

  <!-- Footer (optional) -->
  {
    Astro.slots.has('footer') && (
      <div class="p-6 border-t border-gold-light">
        <slot name="footer" />
      </div>
    )
  }
</div>

<script>
  import { DRAWER_EVENTS } from '../../lib/drawer-events';
  import type { DrawerEventDetail } from '../../lib/drawer-events';
  import { initializeOnce } from '../../lib/client-utils';

  /**
   * Drawer controller using custom events
   *
   * This implementation replaces global window functions with
   * CustomEvent-based communication for better isolation and testability.
   */
  function initDrawers() {
    /**
     * Close a drawer with animation
     */
    function closeDrawer(drawerId: string) {
      const drawer = document.getElementById(drawerId);
      const backdrop = document.getElementById(`${drawerId}-backdrop`);

      if (drawer) {
        drawer.classList.add('translate-x-full');
      }
      if (backdrop) {
        backdrop.classList.add('opacity-0');
        setTimeout(() => {
          backdrop.classList.add('hidden');
        }, 300);
      }
      document.body.classList.remove('overflow-hidden');
    }

    /**
     * Open a drawer with animation
     */
    function openDrawer(drawerId: string) {
      const drawer = document.getElementById(drawerId);
      const backdrop = document.getElementById(`${drawerId}-backdrop`);

      if (backdrop) {
        backdrop.classList.remove('hidden');
        // Trigger reflow for animation
        void backdrop.offsetHeight;
        backdrop.classList.remove('opacity-0');
      }
      if (drawer) {
        drawer.classList.remove('translate-x-full');
      }
      document.body.classList.add('overflow-hidden');
    }

    /**
     * Toggle a drawer's state
     */
    function toggleDrawer(drawerId: string) {
      const drawer = document.getElementById(drawerId);
      if (drawer && drawer.classList.contains('translate-x-full')) {
        openDrawer(drawerId);
      } else {
        closeDrawer(drawerId);
      }
    }

    // Listen for custom events
    document.addEventListener(DRAWER_EVENTS.OPEN, (e) => {
      const event = e as CustomEvent<DrawerEventDetail>;
      openDrawer(event.detail.id);
    });

    document.addEventListener(DRAWER_EVENTS.CLOSE, (e) => {
      const event = e as CustomEvent<DrawerEventDetail>;
      closeDrawer(event.detail.id);
    });

    document.addEventListener(DRAWER_EVENTS.TOGGLE, (e) => {
      const event = e as CustomEvent<DrawerEventDetail>;
      toggleDrawer(event.detail.id);
    });

    // Setup close buttons using event delegation
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const closeBtn = target.closest('[data-drawer-close]') as HTMLElement;
      if (closeBtn) {
        const drawerId = closeBtn.dataset.drawerClose;
        if (drawerId) closeDrawer(drawerId);
      }
    });

    // Setup backdrop click to close using event delegation
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.hasAttribute('data-drawer-backdrop')) {
        const drawerId = target.dataset.drawerBackdrop;
        if (drawerId) closeDrawer(drawerId);
      }
    });

    // ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('[data-drawer]').forEach((drawer) => {
          if (!drawer.classList.contains('translate-x-full')) {
            closeDrawer(drawer.id);
          }
        });
      }
    });
  }

  // Initialize once and re-initialize on Astro page transitions
  initializeOnce('drawers', initDrawers);
  document.addEventListener('astro:page-load', () => {
    initializeOnce('drawers', initDrawers);
  });
</script>
