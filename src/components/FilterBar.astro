---
import type { RubricType } from '../lib/types';
import Input from './ui/Input.astro';
import Select from './ui/Select.astro';
import Button from './ui/Button.astro';

interface Props {
  fromDate?: string;
  toDate?: string;
  rubric?: RubricType | '';
  minScore?: number;
}

const { fromDate, toDate, rubric, minScore } = Astro.props;

// Get current params to preserve (excluding filter fields and pagination)
const currentParams = Astro.url.searchParams;
const excludedParams = ['fromDate', 'toDate', 'rubric', 'minScore', 'page', 'limit'];
const preservedParams: { key: string; value: string }[] = [];

currentParams.forEach((value, key) => {
  if (!excludedParams.includes(key)) {
    preservedParams.push({ key, value });
  }
});

const rubrics: { value: RubricType; label: string }[] = [
  { value: 'exact_match', label: 'Exact Match' },
  { value: 'partial_credit', label: 'Partial Credit' },
  { value: 'semantic_similarity', label: 'Semantic Similarity' },
];
---

<form method="get" class="card-luxe p-5 mb-8 animate-reveal delay-100">
  {preservedParams.map((param) => <input type="hidden" name={param.key} value={param.value} />)}

  <div class="flex flex-wrap items-end gap-4">
    <div class="w-40">
      <Input
        type="date"
        name="fromDate"
        label="From Date"
        value={fromDate}
        size="sm"
        class="border-gold-light focus:border-luxe-gold transition-colors"
      />
    </div>

    <div class="w-40">
      <Input
        type="date"
        name="toDate"
        label="To Date"
        value={toDate}
        size="sm"
        class="border-gold-light focus:border-luxe-gold transition-colors"
      />
    </div>

    <div class="w-48">
      <Select
        name="rubric"
        label="Rubric"
        size="sm"
        class="border-gold-light focus:border-luxe-gold transition-colors"
      >
        <option value="">All Rubrics</option>
        {
          rubrics.map((r) => (
            <option value={r.value} selected={r.value === rubric}>
              {r.label}
            </option>
          ))
        }
      </Select>
    </div>

    <div class="w-28">
      <Input
        type="number"
        name="minScore"
        label="Min Score"
        value={minScore}
        min="0"
        max="100"
        size="sm"
        class="font-mono border-gold-light focus:border-luxe-gold transition-colors"
        placeholder="0-100"
      />
    </div>

    <div class="pb-1">
      <Button type="submit" variant="primary" size="sm" class="font-semibold">
        Filter
      </Button>
    </div>

    <div class="pb-1">
      <Button
        href={Astro.url.pathname +
          (preservedParams.length
            ? '?' + new URLSearchParams(preservedParams.map((p) => [p.key, p.value])).toString()
            : '')}
        variant="ghost"
        size="sm"
      >
        Reset
      </Button>
    </div>
  </div>
</form>
