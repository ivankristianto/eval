---
import SunIcon from '../icons/SunIcon.astro';
import MoonIcon from '../icons/MoonIcon.astro';
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle" id="theme-toggle-btn">
    <SunIcon class="sun-icon" size="md" />
    <MoonIcon class="moon-icon" size="md" />
  </div>
  <ul tabindex="0" class="dropdown-content z-[1] p-3 shadow-2xl bg-base-300 rounded-box w-56">
    <!-- Light Themes -->
    <li class="menu-title px-3 py-2">
      <span class="text-xs font-semibold uppercase tracking-wider opacity-60">Light Themes</span>
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Light"
        value="light"
      />
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Cupcake"
        value="cupcake"
      />
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Silk"
        value="silk"
      />
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Nord"
        value="nord"
      />
    </li>

    <!-- Divider -->
    <li class="my-2"><hr class="border-base-content/10" /></li>

    <!-- Dark Themes -->
    <li class="menu-title px-3 py-2">
      <span class="text-xs font-semibold uppercase tracking-wider opacity-60">Dark Themes</span>
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Dark"
        value="dark"
      />
    </li>
    <li>
      <input
        type="radio"
        name="theme-dropdown"
        class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
        aria-label="Luxury"
        value="luxury"
      />
    </li>
  </ul>
</div>

<style>
  .sun-icon {
    display: block;
  }
  .moon-icon {
    display: none;
  }

  :global([data-theme='dark']) .sun-icon,
  :global([data-theme='luxury']) .sun-icon {
    display: none;
  }

  :global([data-theme='dark']) .moon-icon,
  :global([data-theme='luxury']) .moon-icon {
    display: block;
  }
</style>

<script>
  const prefsKey = 'eval_user_prefs';

  const readPrefs = () => {
    try {
      return JSON.parse(localStorage.getItem(prefsKey) || '{}');
    } catch {
      return {};
    }
  };

  const writePrefs = (theme: string) => {
    const prefs = readPrefs();
    const nextPrefs = {
      ...prefs,
      theme,
    };
    localStorage.setItem(prefsKey, JSON.stringify(nextPrefs));
  };

  function initThemeController() {
    const themeRadios = document.querySelectorAll('input[name="theme-dropdown"]');
    const storedTheme = readPrefs()?.theme || localStorage.getItem('theme');
    const currentTheme =
      document.documentElement.getAttribute('data-theme') || storedTheme || 'light';

    // Check the current theme radio button
    themeRadios.forEach((radio) => {
      if (!(radio instanceof HTMLInputElement)) return;
      radio.checked = radio.value === currentTheme;

      // Remove old listeners (if any) by cloning and replacing
      const newRadio = radio.cloneNode(true) as HTMLInputElement;
      radio.parentNode?.replaceChild(newRadio, radio);

      // Add fresh event listener
      newRadio.addEventListener('change', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        const newTheme = target.value;
        document.documentElement.setAttribute('data-theme', newTheme);
        writePrefs(newTheme);
        localStorage.setItem('theme', newTheme);
      });
    });
  }

  // Initialize
  initThemeController();
  document.addEventListener('astro:page-load', initThemeController);
</script>
